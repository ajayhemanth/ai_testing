// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id                String             @id @default(cuid())
  name              String
  description       String?
  softwareType      String?
  targetCompliances String?
  country           String?
  status            String             @default("active")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  testCases         TestCase[]
  requirements      Requirement[]
  syntheticData     SyntheticData[]
  apiTests          ApiTest[]
  integrations      Integration[]
  complianceChecks  ComplianceCheck[]
  devOpsMetrics     DevOpsMetric[]
  activities        Activity[]
  dataGenerations   DataGeneration[]
}

model TestCase {
  id                  String               @id @default(cuid())
  projectId           String
  project             Project              @relation(fields: [projectId], references: [id])
  title               String
  description         String?
  testSteps           String?
  steps               String?              // Alternative field name for compatibility
  expectedResults     String?
  expectedResult      String?              // Alternative field name for compatibility
  actualResults       String?
  status              String               @default("pending")
  priority            String               @default("medium")
  category            String?
  compliance          String?              // For storing compliance tags
  requirementId       String?
  requirement         Requirement?         @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  complianceMappings  ComplianceMapping[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  lastExecutedAt      DateTime?
  executionHistory    TestExecution[]
  tags                String?
  automationStatus    String               @default("manual")
  syntheticDataId     String?
  syntheticData       SyntheticData?       @relation(fields: [syntheticDataId], references: [id])
  jiraId              String?              // Jira issue key
  azureId             String?              // Azure DevOps work item ID
}

model Requirement {
  id                 String            @id @default(cuid())
  projectId          String
  project            Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title              String
  description        String?
  type               String?
  source             String?
  priority           String            @default("medium")
  status             String            @default("draft")
  testCases          TestCase[]
  complianceTags     String?
  acceptanceCriteria String?
  userStory          String?
  compliance         String?
  testScenarios      String?
  dependencies       String?
  risks              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

model ComplianceStandard {
  id                String              @id @default(cuid())
  name              String              @unique
  version           String?
  country           String?
  description       String?
  categories        String?
  requirements      String?
  mappings          ComplianceMapping[]
  checks            ComplianceCheck[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model ComplianceMapping {
  id           String             @id @default(cuid())
  testCaseId   String
  testCase     TestCase           @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  standardId   String
  standard     ComplianceStandard @relation(fields: [standardId], references: [id])
  subdivision  String?
  status       String             @default("pending")
  notes        String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model ComplianceCheck {
  id         String             @id @default(cuid())
  projectId  String
  project    Project            @relation(fields: [projectId], references: [id])
  standardId String
  standard   ComplianceStandard @relation(fields: [standardId], references: [id])
  status     String             @default("pending")
  coverage   Float              @default(0)
  findings   String?
  checkedAt  DateTime           @default(now())
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
}

model SyntheticData {
  id          String     @id @default(cuid())
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id])
  name        String
  type        String
  schema      String?
  data        String?
  testCases   TestCase[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model ApiTest {
  id            String          @id @default(cuid())
  projectId     String
  project       Project         @relation(fields: [projectId], references: [id])
  name          String
  endpoint      String
  method        String
  headers       String?
  body          String?
  expectedCode  Int?
  expectedBody  String?
  status        String          @default("pending")
  lastRunAt     DateTime?
  executions    ApiExecution[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model ApiExecution {
  id           String   @id @default(cuid())
  apiTestId    String
  apiTest      ApiTest  @relation(fields: [apiTestId], references: [id])
  status       String
  responseCode Int?
  responseBody String?
  responseTime Int?
  error        String?
  executedAt   DateTime @default(now())
}

model TestExecution {
  id         String   @id @default(cuid())
  testCaseId String
  testCase   TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  status     String
  results    String?
  duration   Int?
  error      String?
  executedBy String?
  executedAt DateTime @default(now())
}

model Integration {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  type        String
  name        String
  config      String?
  status      String   @default("inactive")
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DevOpsMetric {
  id              String   @id @default(cuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id])
  pipeline        String?
  buildStatus     String?
  testsPassed     Int      @default(0)
  testsFailed     Int      @default(0)
  testsSkipped    Int      @default(0)
  coverage        Float    @default(0)
  deploymentStatus String?
  timestamp       DateTime @default(now())
  createdAt       DateTime @default(now())
}

model KnowledgeBase {
  id          String   @id @default(cuid())
  title       String
  content     String?
  category    String?
  tags        String?
  embeddings  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Agent {
  id          String   @id @default(cuid())
  name        String
  type        String
  description String?
  config      String?
  status      String   @default("inactive")
  lastRunAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String?
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Activity {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        String   // e.g., "project_created", "test_executed", "status_changed"
  description String
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())
}

model DataGeneration {
  id              String    @id @default(uuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testCaseIds     String    // Comma-separated list of test case IDs
  dataType        String
  outputFormat    String
  recordCount     Int
  complexityLevel String
  metadata        Json?     // Additional metadata like compliance, edge cases, etc.
  createdAt       DateTime  @default(now())
}